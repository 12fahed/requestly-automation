!function(){"use strict";const e="handshakeClient",t="getExecutedRules",n="startRecordingExplicitly",s="stopRecording",i="watchRecording",o="cacheRecordedSessionOnPageUnload",a="initSessionRecorder",r="clientPageLoaded",c="onBeforeAjaxRequest",d="onErrorOccurred",l="saveTestRuleResult",u="notifyTestRuleReportUpdated",g="ruleExecuted",p="ruleSaveError",m="cacheSharedState",E="desktopAppConnectionStatusUpdated",h="notifySessionRecordingStarted",w="notifySessionRecordingStopped",R="isRecordingSession",y="getTabSession",T="startRecording",S="stopRecording",f="isExplicitRecordingSession",v="notifyPageLoadedFromCache",I="onBeforeAjaxRequest:processed",A="onErrorOccurred:processed",C="startExplicitRuleTesting",D="startImplicitRuleTesting",L="notifyRuleExecuted",M="notifyRecordUpdated",q="notifyExtensionStatusUpdated",b="local",P="implicit_rule_testing_widget_config",O=e=>"undefined"!=typeof cloneInto?cloneInto(e,window):e,_={};let k=!1;const x={isRecording:!1,isExplicitRecording:!1,markRecordingIcon:!1,widgetPosition:null,recordingStartTime:null,showWidget:!1},N=()=>{window.addEventListener("pageshow",(e=>{e.persisted&&chrome.runtime.sendMessage({action:v,payload:{isRecordingSession:x.isRecording}})}))},U=async e=>{if(!e)return;await(async()=>new Promise((e=>{k&&e(),chrome.runtime.sendMessage({action:a},(()=>{k=!0,e()}))})))();const{notify:t,markRecordingIcon:n=!0,explicit:s=!1,recordingStartTime:i=Date.now(),showWidget:o,widgetPosition:r,previousSession:c}=e,d=window.top!==window;d||H(),V("startRecording",{relayEventsToTop:d,console:!0,network:!0,maxDuration:60*(e.maxDuration||5)*1e3,previousSession:d?null:c,localStorage:!0}),x.isExplicitRecording=s,x.markRecordingIcon=n,x.showWidget=o,x.widgetPosition=r,x.recordingMode=s?"manual":"auto",t&&z(),s&&(x.recordingStartTime=i,Y())},H=()=>{chrome.runtime.onMessage.addListener(((e,t,n)=>{switch(e.action){case R:n(x.isRecording);break;case y:return V("getSessionData",null,(e=>{n({...e,recordingMode:x.recordingMode})})),!0;case f:n(x.isExplicitRecording);break;case S:V("stopRecording",null)}return!1})),window.addEventListener("message",(function(e){e.source===window&&"requestly:client"===e.data.source&&(e.data.response?F(e.data.action,e.data.payload):"sessionRecordingStarted"===e.data.action?(x.isRecording=!0,chrome.runtime.sendMessage({action:h,payload:{markRecordingIcon:x.markRecordingIcon}}),x.showWidget&&(x.isExplicitRecording?G():Q())):"sessionRecordingStopped"===e.data.action&&(x.isRecording=!1,x.isExplicitRecording=!1,x.markRecordingIcon=!1,j(),Y(),chrome.runtime.sendMessage({action:w})))})),window.addEventListener("beforeunload",(()=>{V("getSessionData",null,(e=>{chrome.runtime.sendMessage({action:o,payload:{session:e,widgetPosition:x.widgetPosition,recordingMode:x.recordingMode,recordingStartTime:x.recordingStartTime}})}))}))},F=(e,t)=>{_[e]?.(t),delete _[e]},V=(e,t,n)=>{window.postMessage({source:"requestly:extension",action:e,payload:t},window.location.href),n&&(_[e]=n)},G=()=>{let e=W();e||(e=document.createElement("rq-session-recording-widget"),e.classList.add("rq-element"),document.documentElement.appendChild(e),e.addEventListener("stop",(()=>{chrome.runtime.sendMessage({action:s,openRecording:!0})})),e.addEventListener("discard",(()=>{chrome.runtime.sendMessage({action:s})})),e.addEventListener("moved",(e=>{x.widgetPosition=e.detail})));const t=Date.now()-x.recordingStartTime,n=t<=3e5?t:null;e.dispatchEvent(new CustomEvent("show",O({detail:{currentRecordingTime:n,position:x.widgetPosition}})))},j=()=>{const e=W();e?.dispatchEvent(new CustomEvent("hide"))},W=()=>document.querySelector("rq-session-recording-widget"),Q=()=>{const e="rq-session-recording-auto-mode-widget";let t=document.querySelector(e);t||(t=document.createElement(e),t.classList.add("rq-element"),document.documentElement.appendChild(t),t.addEventListener("watch",(()=>{chrome.runtime.sendMessage({action:i})})),t.addEventListener("moved",(e=>{x.widgetPosition=e.detail}))),t.dispatchEvent(new CustomEvent("show",O({detail:{position:x.widgetPosition}})))},Y=()=>{let e=document.querySelector("rq-session-recording-auto-mode-widget");e?.dispatchEvent(new CustomEvent("hide"))},z=()=>{const e=document.createElement("rq-toast");e.classList.add("rq-element"),e.setAttribute("heading","Requestly is recording session on this tab!"),e.setAttribute("icon-path",chrome.runtime.getURL("resources/images/128x128.png"));const t='\n  <div slot="content">\n    You can save up to last 5 minutes anytime by clicking on Requestly extension icon to save & upload activity for this tab.\n  </div>\n  ';try{e.innerHTML=t}catch(n){const s=window.trustedTypes?.createPolicy?.("rq-html-policy",{createHTML:e=>e});e.innerHTML=s.createHTML(t)}document.documentElement.appendChild(e)},B=async()=>{const e=await(async()=>new Promise((e=>{chrome.storage[b].get(null,e)})))();return Object.values(e).filter((e=>!!e))},$=async e=>new Promise((t=>{chrome.storage[b].get(e,(n=>t(n[e])))}));var X;!function(e){e[e.MODIFIED=0]="MODIFIED",e[e.CREATED=1]="CREATED",e[e.DELETED=2]="DELETED"}(X||(X={}));const J=(e,t)=>{chrome.storage.onChanged.addListener(((n,s)=>{if(s===b){const s=[];Object.entries(n).forEach((([t,n])=>{let i,o;if(void 0!==n.newValue)i=void 0!==n.oldValue?X.MODIFIED:X.CREATED,o=n.newValue;else{if(void 0===n.oldValue)return;i=X.DELETED,o=n.oldValue}e?.changeTypes?.length&&!e.changeTypes.includes(i)||e?.keyFilter&&t!==e.keyFilter||e?.valueFilter&&!e.valueFilter(o)||s.push({changeType:i,key:t,...n})})),s.length&&t(s)}}))};var K;!function(e){e.IS_EXTENSION_ENABLED="isExtensionEnabled"}(K||(K={}));var Z,ee,te,ne,se,ie,oe,ae,re,ce,de,le,ue="https://app.requestly.io";!function(e){e.GROUP="group",e.RULE="rule"}(Z||(Z={})),function(e){e.ACTIVE="Active",e.INACTIVE="Inactive"}(ee||(ee={})),function(e){e.REDIRECT="Redirect",e.CANCEL="Cancel",e.REPLACE="Replace",e.HEADERS="Headers",e.USERAGENT="UserAgent",e.SCRIPT="Script",e.QUERYPARAM="QueryParam",e.RESPONSE="Response",e.REQUEST="Request",e.DELAY="Delay"}(te||(te={})),function(e){e.URL="Url",e.HOST="host",e.PATH="path"}(ne||(ne={})),function(e){e.EQUALS="Equals",e.CONTAINS="Contains",e.MATCHES="Matches",e.WILDCARD_MATCHES="Wildcard_Matches"}(se||(se={})),function(e){e.PAGE_DOMAINS="pageDomains",e.REQUEST_METHOD="requestMethod",e.RESOURCE_TYPE="resourceType",e.REQUEST_PAYLOAD="requestPayload"}(ie||(ie={})),function(e){e.XHR="xmlhttprequest",e.JS="script",e.CSS="stylesheet",e.Image="image",e.Media="media",e.Font="font",e.WebSocket="websocket",e.MainDocument="main_frame",e.IFrameDocument="sub_frame"}(oe||(oe={})),function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE",e.PATCH="PATCH",e.OPTIONS="OPTIONS",e.CONNECT="CONNECT",e.HEAD="HEAD"}(ae||(ae={})),function(e){e.CUSTOM="custom",e.ALL_PAGES="allPages"}(re||(re={})),function(e){e.SESSION_RECORDING_CONFIG="sessionRecordingConfig"}(ce||(ce={})),function(e){e.JS="js",e.CSS="css"}(de||(de={})),function(e){e.URL="url",e.CODE="code"}(le||(le={}));const ge=e=>e&&(!!e.ruleType||e.objectType===Z.RULE),pe=e=>e&&e.objectType===Z.GROUP,me=async()=>(await B()).filter(ge),Ee=async()=>(await B()).filter(pe);const he=new class{rules=[];groups=[];isInitialized=!1;listeners={};updateCachedRules=async()=>{this.rules=await me(),this.groups=await Ee(),this.isInitialized=!0};constructor(){var e;this.updateCachedRules(),e=()=>{this.updateCachedRules().then((()=>{this.listeners&&Object.values(this.listeners).forEach((e=>e?.()))}))},J({valueFilter:ge},(t=>{t.some((({changeType:e,oldValue:t,newValue:n})=>e===X.CREATED&&n.status===ee.ACTIVE||e===X.DELETED&&t.status===ee.ACTIVE||e===X.MODIFIED))&&e()})),J({valueFilter:pe,changeTypes:[X.MODIFIED]},(t=>{t.some((({oldValue:e,newValue:t})=>e.status!==t.status))&&e()}))}onRuleOrGroupChange=e=>{const t=Date.now();return this.listeners[t]=e,()=>{this.listeners[t]&&delete this.listeners[t]}};getAllRules=async()=>this.isInitialized?this.rules:me();getAllGroups=async()=>this.isInitialized?this.groups:Ee();getRule=async e=>this.getAllRules().then((t=>t.find((t=>t.id===e))));getRules=async e=>this.getAllRules().then((t=>t.filter((t=>e.includes(t.id)))));getEnabledRules=async e=>{const t=await this.getAllRules(),n=await this.getAllGroups();return t.filter((t=>{if(!t.status||t.status===ee.INACTIVE)return!1;if(e&&t.ruleType!==e)return!1;if(!t.groupId)return!0;return n.find((e=>e.id===t.groupId)).status===ee.ACTIVE}))}};const we=new class{constructor(){this.initListeners()}initListeners=()=>{chrome.runtime.onMessage.addListener(((e,t,n)=>{if(e.action===L)this.onRuleExecuted(e.rule,e.requestDetails)}))};getExecutedRules=async()=>chrome.runtime.sendMessage({action:t});onRuleExecuted=(e,t)=>{De(e)}};let Re=!1,ye=!1,Te=null;const Se=async e=>{if(document.querySelector("rq-explicit-test-rule-widget"))return;const t=await he.getRule(e),{name:n}=t,s=document.createElement("rq-explicit-test-rule-widget");s.classList.add("rq-element"),s.setAttribute("rule-id",e),s.setAttribute("rule-name",n),fe(s,t),s.setAttribute("applied-status","false"),document.documentElement.appendChild(s),s.addEventListener("view-results",(()=>{chrome.runtime.sendMessage({action:l,ruleId:e,appliedStatus:"true"===s?.getAttribute("applied-status")})}));const i=await we.getExecutedRules();i&&i?.forEach((e=>{ve(e.id)}))},fe=(e,t)=>{const{ruleType:n}=t,s="rq-test-rule-text";switch(n){case te.RESPONSE:e.setAttribute(s,'The responses are modified, but won\'t show in DevTools due to technical constraints. See <a class="link" target="_blank" href="https://docs.requestly.com/general/http-rules/advanced-usage/test-rules">docs</a> for details.');break;case te.HEADERS:t.pairs.some((e=>e?.modifications?.Response?.length>0))&&e.setAttribute(s,'Response Header Modifications will not show up in the browser network devtools due to technical constraints. Checkout docs for more <a target="_blank" href="https://docs.requestly.com/general/http-rules/rule-types/modify-headers">details</a>.');break;default:return}},ve=e=>{const t=document.querySelector("rq-explicit-test-rule-widget");t&&"false"===t?.getAttribute("applied-status")&&(t.getAttribute("rule-id")===e&&t.setAttribute("applied-status","true"),t.dispatchEvent(new CustomEvent("new-rule-applied",O({detail:{appliedRuleId:e}}))))},Ie=async()=>{if(document.querySelector("rq-implicit-test-rule-widget"))return;const e=document.createElement("rq-implicit-test-rule-widget");e.classList.add("rq-element"),e.style.display="none",e.addEventListener("view_rule_in_editor",(e=>{window.open(`${ue}/rules/editor/edit/${e.detail.ruleId}`,"_blank")})),e.addEventListener("open_app_settings",(()=>{window.open(`${ue}/settings/global-settings`,"_blank")})),document.documentElement.appendChild(e);const t=await we.getExecutedRules();t&&t?.forEach((e=>{Ae(e)}))},Ae=async e=>{let t=e.name,n=e.ruleType;if(!t||!n){const s=await he.getRule(e.id);t=s.name,n=s.ruleType}if(!Le(n))return;const s=document.querySelector("rq-implicit-test-rule-widget");s&&(fe(s,e),s.dispatchEvent(new CustomEvent("new-rule-applied",O({detail:{appliedRuleId:e.id,appliedRuleName:t,appliedRuleType:n}}))),s.style.display="block")},Ce=async()=>{$(P).then((e=>{e&&(Te=e)}))},De=async e=>{Re?Ae(e):ye&&ve(e.id)},Le=e=>{const t=Te;return!(!t||!t.enabled)&&!(t.visibility===Me.SPECIFIC&&!t.ruleTypes.includes(e))};var Me;!function(e){e.ALL="all",e.SPECIFIC="specific"}(Me||(Me={}));const qe={};const be="content_script",Pe="source",Oe=(e,t)=>{e.action&&(t&&((e,t)=>{if(!t)return;qe[e.action+"_1"]=t,e.requestId=1})(e,t),e[Pe]=be,window.postMessage(e,window.origin))};("html"===document.doctype?.name||document.contentType?.includes("html"))&&(chrome.runtime.onMessage.addListener(((e,t,n)=>{switch(e.action){case r:chrome.runtime.sendMessage({action:r});break;case u:case M:case p:case E:case q:Oe(e)}})),(async(e,t)=>{return await $((n=e,`rq_var_${n}`))??t;var n})(K.IS_EXTENSION_ENABLED,!0).then((t=>{t&&(chrome.runtime.sendMessage({action:e}),chrome.runtime.onMessage.addListener((e=>{e.action===T&&U(e.payload)})),N(),window.addEventListener("message",(function(e){if(e.source===window&&"requestly:client"===e.data.source)switch(e.data.action){case"response_rule_applied":case"request_rule_applied":chrome.runtime.sendMessage({action:g,rule:e.data.rule,requestDetails:e.data.requestDetails});break;case c:chrome.runtime.sendMessage(e.data,(()=>{window.postMessage({source:"requestly:client",action:I},window.location.href)}));break;case d:chrome.runtime.sendMessage(e.data,(()=>{window.postMessage({source:"requestly:client",action:A},window.location.href)}));break;case m:chrome.runtime.sendMessage(e.data)}})),Ce(),chrome.runtime.onMessage.addListener(((e,t,s)=>{switch(e.action){case C:e.record&&chrome.runtime.sendMessage({action:n,showWidget:!1}),ye=!0,Se(e.ruleId);break;case D:Te?.enabled&&(Re=!0,Ie())}return!1})))})))}();
