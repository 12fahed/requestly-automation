!function(){"use strict";var e,t,s,a,n,r,o,i,c,d,u,l;!function(e){e.GROUP="group",e.RULE="rule"}(e||(e={})),function(e){e.ACTIVE="Active",e.INACTIVE="Inactive"}(t||(t={})),function(e){e.REDIRECT="Redirect",e.CANCEL="Cancel",e.REPLACE="Replace",e.HEADERS="Headers",e.USERAGENT="UserAgent",e.SCRIPT="Script",e.QUERYPARAM="QueryParam",e.RESPONSE="Response",e.REQUEST="Request",e.DELAY="Delay"}(s||(s={})),function(e){e.URL="Url",e.HOST="host",e.PATH="path"}(a||(a={})),function(e){e.EQUALS="Equals",e.CONTAINS="Contains",e.MATCHES="Matches",e.WILDCARD_MATCHES="Wildcard_Matches"}(n||(n={})),function(e){e.PAGE_DOMAINS="pageDomains",e.REQUEST_METHOD="requestMethod",e.RESOURCE_TYPE="resourceType",e.REQUEST_PAYLOAD="requestPayload"}(r||(r={})),function(e){e.XHR="xmlhttprequest",e.JS="script",e.CSS="stylesheet",e.Image="image",e.Media="media",e.Font="font",e.WebSocket="websocket",e.MainDocument="main_frame",e.IFrameDocument="sub_frame"}(o||(o={})),function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE",e.PATCH="PATCH",e.OPTIONS="OPTIONS",e.CONNECT="CONNECT",e.HEAD="HEAD"}(i||(i={})),function(e){e.CUSTOM="custom",e.ALL_PAGES="allPages"}(c||(c={})),function(e){e.SESSION_RECORDING_CONFIG="sessionRecordingConfig"}(d||(d={})),function(e){e.JS="js",e.CSS="css"}(u||(u={})),function(e){e.URL="url",e.CODE="code"}(l||(l={}));var p="https://app.requestly.io",h=["https://app.requestly.com","https://requestly.com"],E={browser:"chrome",storageType:"local",contextMenuContexts:["browser_action"],env:"prod",WEB_URL:p,SESSIONS_URL:"https://app.requestly.io/sessions",OTHER_WEB_URLS:h,LANDING_PAGE_BASE_URL:"https://requestly.com",logLevel:"info"};const m=e=>{const t=e.match(new RegExp("^/(.+)/(|i|g|ig|gi)$"));if(!t)return null;try{return new RegExp(t[1],t[2])}catch(e){return null}},g=(e,t)=>{e.startsWith("/")||(e=`/${e}/`);const s=m(e);return s?.test(t)},S=e=>"/^"+e.replace(/([?.-])/g,"\\$1").replace(/(\*)/g,"(.*)")+"$/",R=(e,t)=>{const s=((e,t)=>{let s=null;try{s=new URL(e)}catch(e){}if(s)switch(t){case a.URL:return e;case a.HOST:return s.host;case a.PATH:return s.pathname}})(t,e.key),r=e.value;if(!(e.isActive??!0))return!1;if(!s)return!1;switch(e.operator){case n.EQUALS:if(r===s)return!0;break;case n.CONTAINS:if(-1!==s.indexOf(r))return!0;break;case n.MATCHES:return g(r,s);case n.WILDCARD_MATCHES:return((e,t)=>{const s=S(e);return g(s,t)})(r,s)}return!1},T=(e,t)=>{if(!e)return!0;if("object"==typeof e&&0===Object.keys(e).length)return!0;if(!t||"object"!=typeof t)return!1;if(0===Object.keys(t).length)return!1;const s=e?.key,a=e?.value;if(s&&void 0!==typeof a){const n=A(t,s),r=e?.operator;let o="";if("object"==typeof n||(o=n?.toString()),!r||"Equals"===r)return o===a;if("Contains"===r)return o.includes(a)}return!1},I=function(e,t){if(De(t.initiator)||De(t.url))return{};const s=e?.pairs?.find((e=>R(e.source,t.url)&&function(e,t){if(!e||!t||Array.isArray(e)&&0===e?.length)return!0;const s=Array.isArray(e)?e[0]:e;return Object.entries(s).every((([e,s])=>{switch(e){case r.PAGE_DOMAINS:return s.some((e=>{const s=we(t.initiator);return(s?.hostname||"").endsWith(e)}));case r.REQUEST_METHOD:return s.includes(t.method);case r.RESOURCE_TYPE:return s.includes(t.type);case r.REQUEST_PAYLOAD:return T(s,t.requestData);default:return!0}}))}(e.source.filters,t)));if(!s)return{isApplied:!1};return{isApplied:!0,matchedPair:s,destinationUrl:y(s,e.ruleType,t)}},f=function(e,t){return t.forEach((function(t,s){0!==s&&(t=t||"",e=e.replace(new RegExp("[$]"+s,"g"),t))})),e},y=(e,t,a)=>{switch(t){case s.REPLACE:const t=a.url.replace(e.from,e.to);return t===a.url?null:t;case s.REDIRECT:if(e.source.operator===n.MATCHES){const t=m(e.source.value)?.exec(a.url);return t?f(e.destination,t):e.destination}if(e.source.operator===n.WILDCARD_MATCHES){const t=e.source.value,s=S(t),n=m(s)?.exec(a.url);return n?f(e.destination,n):e.destination}return e.destination;default:return null}},b=(e,t)=>{for(const s of e){const e=I(s,t);if(e.isApplied)return e}return null},A=(e,t)=>{if(!t)return;const s=t.split(".");try{for(let t=0;t<s.length-1;t++)e=e[s[t]];return e[s[s.length-1]]}catch(e){}},D="getRulesAndGroups",w="getTabSession",_="handshakeClient",C="getAPIResponse",O="getExecutedRules",L="checkIfNoRulesPresent",x="startRecordingExplicitly",N="startRecordingOnUrl",v="stopRecording",P="watchRecording",U="checkIfExtensionEnabled",k="toggleExtensionStatus",M="cacheRecordedSessionOnPageUnload",q="initSessionRecorder",G="clientPageLoaded",H="onBeforeAjaxRequest",F="onErrorOccurred",B="saveTestRuleResult",j="notifyTestRuleReportUpdated",V="testRuleOnUrl",W="ruleExecuted",$="notifyRecordUpdatedInPopup",X="ruleSaveError",Q="isExtensionBlockedOnTab",J="cacheSharedState",Y="isProxyApplied",K="checkIfDesktopAppOpen",z="connectToDesktopApp",Z="disconnectFromDesktopApp",ee="desktopAppConnectionStatusUpdated",te="getExtensionMetadata",se="notifySessionRecordingStarted",ae="notifySessionRecordingStopped",ne="getTabSession",re="startRecording",oe="stopRecording",ie="startExplicitRuleTesting",ce="startImplicitRuleTesting",de="notifyRuleExecuted",ue="notifyRecordUpdated",le="notifyExtensionStatusUpdated",pe="local",he="testReports",Ee="blocked_domains",me=async()=>{const e=await(async()=>new Promise((e=>{chrome.storage[pe].get(null,e)})))();return Object.values(e).filter((e=>!!e))},ge=async(e,t)=>{await(async e=>{await chrome.storage[pe].set(e)})({[e]:t})},Se=async e=>new Promise((t=>{chrome.storage[pe].get(e,(s=>t(s[e])))}));var Re;!function(e){e[e.MODIFIED=0]="MODIFIED",e[e.CREATED=1]="CREATED",e[e.DELETED=2]="DELETED"}(Re||(Re={}));const Te=(e,t)=>{chrome.storage.onChanged.addListener(((s,a)=>{if(a===pe){const a=[];Object.entries(s).forEach((([t,s])=>{let n,r;if(void 0!==s.newValue)n=void 0!==s.oldValue?Re.MODIFIED:Re.CREATED,r=s.newValue;else{if(void 0===s.oldValue)return;n=Re.DELETED,r=s.oldValue}e?.changeTypes?.length&&!e.changeTypes.includes(n)||e?.keyFilter&&t!==e.keyFilter||e?.valueFilter&&!e.valueFilter(r)||a.push({changeType:n,key:t,...s})})),a.length&&t(a)}}))};var Ie;!function(e){e.IS_EXTENSION_ENABLED="isExtensionEnabled"}(Ie||(Ie={}));const fe=e=>`rq_var_${e}`,ye=async(e,t)=>{await ge(fe(e),t)},be=(e,t)=>{Te({keyFilter:fe(e),changeTypes:[Re.MODIFIED]},(e=>{t(e[e.length-1].newValue,e[0].oldValue)}))},Ae=()=>[...new Set([E.WEB_URL,...E.OTHER_WEB_URLS])],De=e=>[...Ae().map((e=>({key:a.URL,operator:n.CONTAINS,value:e}))),{key:a.URL,operator:n.CONTAINS,value:"__rq"}].some((t=>R(t,e))),we=e=>{try{return new URL(e)}catch(e){return null}},_e=async()=>await(async(e,t)=>await Se(fe(e))??t)(Ie.IS_EXTENSION_ENABLED,!0);let Ce=null;const Oe=async()=>{const e=await Se(Ee);Ce=e??[]},Le=async()=>Ce||(await Oe(),Ce),xe=async e=>{const t=await Le();return t?.some((t=>R({key:a.HOST,value:`/^(.+.)?${t}$/i`,operator:n.MATCHES},e)))},Ne=e=>{Te({keyFilter:Ee,changeTypes:[Re.MODIFIED]},(()=>{Oe().then((()=>{e?.()}))}))},ve=t=>t&&(!!t.ruleType||t.objectType===e.RULE),Pe=t=>t&&t.objectType===e.GROUP,Ue=async()=>(await me()).filter(ve),ke=async()=>(await me()).filter(Pe),Me=e=>{Te({valueFilter:ve},(s=>{s.some((({changeType:e,oldValue:s,newValue:a})=>e===Re.CREATED&&a.status===t.ACTIVE||(e===Re.DELETED&&s.status===t.ACTIVE||e===Re.MODIFIED)))&&e()})),Te({valueFilter:Pe,changeTypes:[Re.MODIFIED]},(t=>{t.some((({oldValue:e,newValue:t})=>e.status!==t.status))&&e()}))};const qe=new class{rules=[];groups=[];isInitialized=!1;listeners={};updateCachedRules=async()=>{this.rules=await Ue(),this.groups=await ke(),this.isInitialized=!0};constructor(){this.updateCachedRules(),Me((()=>{this.updateCachedRules().then((()=>{this.listeners&&Object.values(this.listeners).forEach((e=>e?.()))}))}))}onRuleOrGroupChange=e=>{const t=Date.now();return this.listeners[t]=e,()=>{this.listeners[t]&&delete this.listeners[t]}};getAllRules=async()=>this.isInitialized?this.rules:Ue();getAllGroups=async()=>this.isInitialized?this.groups:ke();getRule=async e=>this.getAllRules().then((t=>t.find((t=>t.id===e))));getRules=async e=>this.getAllRules().then((t=>t.filter((t=>e.includes(t.id)))));getEnabledRules=async e=>{const s=await this.getAllRules(),a=await this.getAllGroups();return s.filter((s=>{if(!s.status||s.status===t.INACTIVE)return!1;if(e&&s.ruleType!==e)return!1;if(!s.groupId)return!0;return a.find((e=>e.id===s.groupId)).status===t.ACTIVE}))}};var Ge;!function(e){e.TAB="tabData",e.PAGE="pageData"}(Ge||(Ge={}));const He=new class{map={};constructor(){this.initTabs(),this.addEventListeners()}initTabs(){chrome.tabs.query({},(e=>{this.map={},e.forEach((e=>this.addOrUpdateTab(e)))}))}addEventListeners(){chrome.tabs.onCreated.addListener((e=>this.addOrUpdateTab(e))),chrome.tabs.onRemoved.addListener((e=>this.removeTab(e))),chrome.tabs.onReplaced.addListener(((e,t)=>{this.removeTab(t),chrome.tabs.get(e,(e=>this.addOrUpdateTab(e)))})),chrome.tabs.onUpdated.addListener(((e,t,s)=>{const a=this.getTab(e);if(!a)return void this.addOrUpdateTab(s);const n={...s,[Ge.TAB]:a[Ge.TAB]||{},[Ge.PAGE]:a[Ge.PAGE]||{}};this.addOrUpdateTab(n)})),chrome.webRequest.onBeforeRequest.addListener((e=>{if("main_frame"===e.type){const t=this.getTab(e.tabId)||{id:e.tabId};this.addOrUpdateTab({...t,url:e.url})}}),{urls:["<all_urls>"]}),chrome.webNavigation.onCommitted.addListener((e=>{0===e.frameId&&this.resetPageData(e.tabId)})),chrome.webNavigation.onDOMContentLoaded.addListener((e=>{if(0===e.frameId){this.getTab(e.tabId)&&this.sendMessage(e.tabId,{action:G})}}))}sendMessage(e,...t){chrome.tabs.sendMessage(e,...t)}async getAppTabs(){const e=Ae();let t=[];for(const s of e){const e=await chrome.tabs.query({url:s+"/*"});t=[...t,...e]}return t}addOrUpdateTab(e){e.id!==chrome.tabs.TAB_ID_NONE&&(this.map[e.id]={...this.map[e.id],...e})}createNewTab(e,t,s){chrome.tabs.create({url:e,openerTabId:t},(e=>{s(e)}))}removeTab(e){const t=this.getData(e,Fe.SESSION_RULES_MAP);let s=[];if(t){for(const e of Object.values(t))s.push(...Object.values(e));chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:s})}delete this.map[e]}getTabs(){return this.map}getTab(e){return this.getTabs()[e]}getTabUrl(e){var t=this.getTab(e);return t&&t.url}focusTab(e){var t=this.getTab(e);if(t&&t.windowId)try{return chrome.windows.update(t.windowId,{focused:!0},(()=>{chrome.tabs.highlight({windowId:t.windowId,tabs:t.index})})),!0}catch(e){return!1}return!1}closeTab(e){chrome.tabs.remove(e)}ensureTabLoadingComplete(e){return new Promise((async(t,s)=>{const a=await chrome.tabs.get(e);if(a)if("complete"===a.status)t();else{const s=(a,n)=>{a===e&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(s),t())};chrome.tabs.onUpdated.addListener(s)}else s()}))}setDataForScope(e,t,s,a){const n=this.getTab(t);n?n[e]?n[e][s]=a:n[e]={[s]:a}:this.addOrUpdateTab({id:t,[Ge.TAB]:{[s]:a}})}getDataForScope(e,t,s,a){const n=this.getTab(t);if(n)return n[e]?.[s]||a}removeDataForScope(e,t,s){const a=this.getTab(t);a&&a[e]&&delete a[e][s]}setData(e,t,s){this.setDataForScope(Ge.TAB,e,t,s)}getData(e,t,s){return this.getDataForScope(Ge.TAB,e,t,s)}removeData(e,t){this.removeDataForScope(Ge.TAB,e,t)}setPageData(e,t,s){this.setDataForScope(Ge.PAGE,e,t,s)}getPageData(e,t,s){return this.getDataForScope(Ge.PAGE,e,t,s)}removePageData(e,t){this.removeDataForScope(Ge.PAGE,e,t)}resetPageData(e){const t=this.getTab(e);t?.[Ge.PAGE]&&(t[Ge.PAGE]={})}};self.tabService=He;const Fe={SESSION_RECORDING:"sessionRecording",SESSION_RULES_MAP:"sessionRulesMap",TEST_RULE_DATA:"testRuleData",APPLIED_RULE_DETAILS:"appliedRuleDetails",RULES_EXECUTION_LOGS:"rulesExecutionLogs",SHARED_STATE:"sharedState"};const Be=new class{cacheSharedStateOnPage(e){const t=He.getData(e,Fe.SHARED_STATE,{});chrome.scripting.executeScript({target:{tabId:e,frameIds:[0]},func:(e,t)=>{window[t]=window[t]||{},window[t].sharedState=e},args:[t,"__REQUESTLY__"],injectImmediately:!0,world:"MAIN"})}constructor(){}updateSharedStateInStorage(e,t){He.setData(e,Fe.SHARED_STATE,t)}initSharedStateCaching(e){this.cacheSharedStateOnPage(e)}},je=[p,...h].map((e=>{try{const t=new URL(e);return`${t.protocol}//${t.host}/*`}catch(t){return console.error(`Invalid URL: ${e}`,t),null}})).filter((e=>!!e)),Ve=e=>[`*://${e}/*`,`*://*.${e}/*`],We=[{id:"page-script-ajaxInterceptor",js:["page-scripts/ajaxRequestInterceptor.ps.js"],world:"MAIN",allFrames:!0,persistAcrossSessions:!1,matches:["http://*/*","https://*/*"],runAt:"document_start",excludeMatches:je},{id:"page-script-sessionRecorder",js:["page-scripts/sessionRecorderHelper.ps.js"],world:"MAIN",persistAcrossSessions:!1,matches:["http://*/*","https://*/*"],runAt:"document_start"}],$e=async()=>(console.log("[unregisterClientScript]"),chrome.scripting.unregisterContentScripts({ids:We.map((e=>e.id))}).then((()=>{console.log("[unregisterClientScript]","unregisterClientScript complete"),chrome.scripting.getRegisteredContentScripts().then((e=>console.log("[unregisterClientScript]","registered content scripts",e)))})).catch((e=>console.warn("[unregisterClientScript]","unexpected error",e)))),Xe=async e=>{console.log("[initClientHandler.setupClientScript]",{isExtensionStatusEnabled:e}),e?(async()=>{const e=await Le(),t=e.flatMap(Ve).filter((e=>!!e));console.log("[registerClientScript]",{blockedDomains:e});const s=We.map((e=>({...e,excludeMatches:[...e.excludeMatches??[],...t]})));chrome.scripting.registerContentScripts(s).then((()=>{console.log("[registerClientScript]"),chrome.scripting.getRegisteredContentScripts().then((e=>console.log("[registerClientScript]","registered content scripts",e)))})).catch((e=>console.warn("[unregisterClientScript]","unexpected error",e)))})():$e()},Qe=e=>{const t="__REQUESTLY__";window[t]=window[t]||{},Object.keys(e).map((s=>{window[t][s]=e[s]}))},Je=async(e,t)=>{const a=await qe.getEnabledRules(s.REQUEST);(async(e,t,s)=>{const a={tabId:e};void 0!==s?a.frameIds=[s]:a.allFrames=!0,chrome.scripting.executeScript({target:a,func:Qe,args:[t],injectImmediately:!0,world:"MAIN"},(()=>{}))})(e,{responseRules:await qe.getEnabledRules(s.RESPONSE),requestRules:a,delayRules:await qe.getEnabledRules(s.DELAY)},t)};const Ye=new class{#e=!1;#t=!1;#s={DEFAULT:"/resources/images/48x48.png",DISABLED:"/resources/images/48x48_greyscale.png",BLOCKED:"/resources/images/48x48_blocked.png",RULE_EXECUTED:"/resources/images/48x48_green.png",DEFAULT_WITH_REC:"/resources/images/48x48_rec.png",RULE_EXECUTED_WITH_REC:"/resources/images/48x48_green_rec.png",CONNECTED_TO_DESKTOP_APP:"/resources/images/48x48_desktop.png"};#a={PAGE_DATA_ICON_CONFIG:"extensionIconConfig"};constructor(){chrome.tabs.onUpdated.addListener(((e,t,s)=>{xe(s.url).then((t=>{t?this.markExtensionBlocked(e):this.#n(e)}))}))}#r(){return{ruleExecuted:!1,isRecording:!1}}#o(e){return this.#t?this.#s.CONNECTED_TO_DESKTOP_APP:this.#e?this.#s.DISABLED:e.ruleExecuted?e.isRecording?this.#s.RULE_EXECUTED_WITH_REC:this.#s.RULE_EXECUTED:e.isRecording?this.#s.DEFAULT_WITH_REC:e.isBlocked?this.#s.BLOCKED:this.#s.DEFAULT}#n(e,t,s){let a=He.getPageData(e,this.#a.PAGE_DATA_ICON_CONFIG)??this.#r();t&&a[t]!==s&&(a={...a,[t]:s}),He.setPageData(e,this.#a.PAGE_DATA_ICON_CONFIG,a),this.#i(this.#o(a),e)}#c(){const e=He.getTabs();Object.values(e).forEach((e=>this.#n(e.id)))}#i(e,t){void 0===t?chrome.action.setIcon({path:e}):chrome.action.setIcon({path:e,tabId:t})}markExtensionEnabled=()=>{this.#e=!1,this.#i(this.#s.DEFAULT),this.#c()};markExtensionDisabled=()=>{this.#e=!0,this.#i(this.#s.DISABLED),this.#c()};markRuleExecuted(e){this.#n(e,"ruleExecuted",!0)}markRecording(e){this.#n(e,"isRecording",!0)}markNotRecording(e){this.#n(e,"isRecording",!1)}markExtensionBlocked(e){this.#n(e,"isBlocked",!0)}markConnectedToDesktopApp(){this.#t=!0,this.#i(this.#s.CONNECTED_TO_DESKTOP_APP),this.#c()}markDisconnectedFromDesktopApp(){this.#t=!1,this.#i(this.#s.DEFAULT),this.#c()}getState(){return{isExtensionDisabled:this.#e,connectedToDesktopApp:this.#t}}},Ke=async e=>{const t=await He.getAppTabs();return Promise.all(t.map((({id:t})=>chrome.tabs.sendMessage(t,e))))},ze=(e,t=[],s=!1)=>{const a=()=>{const s=document.createElement("script");t.length?t.forEach((({name:e,value:t})=>{s.setAttribute(e,t??"")})):s.type="text/javascript",s.classList.add("__RQ_SCRIPT__"),s.appendChild(document.createTextNode(e));(document.head||document.documentElement).appendChild(s)};s&&"loading"===document.readyState?document.addEventListener("DOMContentLoaded",a):a()},Ze=(e,t=[],s=!1)=>new Promise((a=>{const n=()=>{const s=document.createElement("script");t.length?t.forEach((({name:e,value:t})=>{s.setAttribute(e,t??"")})):s.type="text/javascript",s.classList.add("__RQ_SCRIPT__"),s.src=e,s.onload=()=>a();(document.head||document.documentElement).appendChild(s)};s&&"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n):n()})),et=function(e,t=[]){var s=document.createElement("style");s.appendChild(document.createTextNode(e)),t.length&&t.forEach((({name:e,value:t})=>{s.setAttribute(e,t??"")})),s.classList.add("__RQ_SCRIPT__");(document.head||document.documentElement).appendChild(s)},tt=function(e,t=[]){var s=document.createElement("link");t.length?t.forEach((({name:e,value:t})=>{s.setAttribute(e,t??"")})):(s.type="text/css",s.rel="stylesheet"),s.href=e,s.classList.add("__RQ_SCRIPT__");(document.head||document.documentElement).appendChild(s)},st=(e,t)=>new Promise((s=>{let a;a=e.codeType===u.JS?e.type===l.URL?Ze:ze:e.type===l.URL?tt:et;const n=e.attributes??[];chrome.scripting.executeScript({target:t,func:a,args:[e.value,n,"afterPageLoad"===e.loadTime],world:"MAIN",injectImmediately:!0},s)})),at=(e,t)=>new Promise((s=>{chrome.scripting.executeScript({target:t,files:[e],world:"MAIN",injectImmediately:!0},s)})),nt=async e=>{if("boolean"!=typeof e)throw console.log(`[updateExtensionStatus] newStatus is not boolean but ${typeof e}. returning...`),new Error("[updateExtensionStatus] newStatus is not boolean but "+typeof e);return console.log("[updateExtensionStatus] starting...",{newStatus:e,extensionIconState:Ye.getState()}),await ye(Ie.IS_EXTENSION_ENABLED,e),lt(e),Ke({action:le,isExtensionEnabled:e,extensionIconState:Ye.getState()}),e},rt=async e=>{const t=await Se("sessionRecordingConfig");if(!t)return null;let s=t?.pageSources||[];if(await _e()){if("autoRecording"in t){if(!t?.autoRecording.isActive)return null;t?.autoRecording.mode===c.ALL_PAGES&&(s=[{value:"*",key:a.URL,isActive:!0,operator:n.WILDCARD_MATCHES}])}if(s.some((t=>R(t,e))))return t}return null},ot=e=>{chrome.tabs.create({url:`${E.WEB_URL}/sessions/draft/${e}`})},it=(e,t)=>chrome.tabs.sendMessage(e,{action:re,payload:t}),ct=(e,t)=>{chrome.tabs.sendMessage(e,{action:oe},(()=>{He.removeData(e,Fe.SESSION_RECORDING)})),t&&ot(e)};var dt,ut;!function(e){e.TOGGLE_ACTIVATION_STATUS="toggle-activation-status"}(dt||(dt={})),function(e){e.ACTIVATE="Activate Requestly",e.DEACTIVATE="Deactivate Requestly"}(ut||(ut={}));const lt=e=>{chrome.contextMenus.update(dt.TOGGLE_ACTIVATION_STATUS,{title:e?ut.DEACTIVATE:ut.ACTIVATE}),console.log("[updateActivationStatus] starting...",{isExtensionEnabled:e,extensionIconState:Ye.getState()}),e?Ye.markExtensionEnabled():Ye.markExtensionDisabled(),console.log("[updateActivationStatus] finished...",{isExtensionEnabled:e,extensionIconState:Ye.getState()}),!1===e&&Object.values(He.getTabs()).forEach((({id:e})=>{e&&He.getData(e,Fe.SESSION_RECORDING)&&ct(e,!1)}))},pt=new Map,ht=(e,t)=>{const s=pt.get(e);s&&s.postMessage(t)},Et=e=>{e.reason===chrome.runtime.OnInstalledReason.INSTALL&&chrome.tabs.create({url:E.LANDING_PAGE_BASE_URL+"/extension-installed-success"})};const mt=new class{constructor(){}getExecutedRules=async e=>{const t=[...He.getPageData(e,Fe.RULES_EXECUTION_LOGS,[]),...He.getData(e,Fe.RULES_EXECUTION_LOGS,[])].map((e=>e.ruleId)).filter((e=>!!e)),s=Array.from(new Set(t));return await qe.getRules(s)};processTabCachedRulesExecutions=async e=>{const t=He.getData(e,Fe.RULES_EXECUTION_LOGS,[])||[],s=Array.from(new Set(t.map((e=>e.ruleId)))),a=(await qe.getRules(s)).reduce(((e,t)=>(e[t.id]=t,e)),{});t.forEach((e=>{this.onRuleExecuted(a[e.ruleId],e.requestDetails)})),He.removeData(e,Fe.RULES_EXECUTION_LOGS)};onRuleExecuted=(e,t,s)=>{const a=s?Ge.TAB:Ge.PAGE;Ye.markRuleExecuted(t.tabId),chrome.tabs.sendMessage(t.tabId,{action:de,rule:e}),((e,t)=>{ht(t.tabId,{rule:e,timestamp:t.timeStamp||Date.now(),requestURL:t.url,requestType:t.type,requestMethod:t.method})})(e,t);const n=He.getDataForScope(a,t.tabId,Fe.RULES_EXECUTION_LOGS,[])||[];n.push({ruleId:e.id,requestDetails:t}),He.setDataForScope(a,t.tabId,Fe.RULES_EXECUTION_LOGS,n)}};var gt,St;!function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.PATCH="PATCH",e.DELETE="DELETE",e.HEAD="HEAD",e.OPTIONS="OPTIONS"}(gt||(gt={})),function(e){e.RAW="text/plain",e.JSON="application/json",e.FORM="application/x-www-form-urlencoded"}(St||(St={}));async function Rt(e){const t=e.method||"GET",s=new Headers,a=e.body;let n=e.url,r=a;if(e?.queryParams.length){const t=new URL(e.url),s=new URLSearchParams(t.search);e.queryParams.forEach((({key:e,value:t})=>{s.append(e,t)})),t.search=s.toString(),n=t.toString()}if(e?.headers.forEach((({key:e,value:t})=>{s.append(e,t)})),((e,t)=>![gt.GET,gt.HEAD].includes(e)&&t===St.FORM)(e.method,e.contentType)){const e=new FormData;a?.forEach((({key:t,value:s})=>{e.append(t,s)}));const t=new URLSearchParams;for(const[s,a]of e.entries())t.append(s,a);r=t}try{const e=performance.now(),a=await fetch(n,{method:t,headers:s,body:r,credentials:"omit"}),o=performance.now()-e,i=[];for(const[e,t]of a.headers.entries())i.push({key:e,value:t});const c=await a.blob(),d=i.find((e=>"content-type"===e.key.toLowerCase()))?.value;let u;if(d?.includes("image/")){const e=e=>new Promise(((t,s)=>{const a=new FileReader;a.onload=e=>t(e.target.result),a.onerror=()=>s(null),a.readAsDataURL(e)}));u=await e(c)}else u=await c.text();return{body:u,time:o,headers:i,status:a.status,statusText:a.statusText,redirectedUrl:a.url!==n?a.url:""}}catch(e){return{error:e.message}}}var Tt;!function(e){e.FORWARD_IGNORED_HEADERS="forwardIgnoredHeaders",e.INITIATOR_DOMAIN="initiatorDomain",e.CSP_ERROR="cspError"}(Tt||(Tt={}));const It=["main_frame","sub_frame","stylesheet","script","image","font","object","xmlhttprequest","ping","csp_report","media","websocket","other"],ft=async e=>{const t=new Set;for(;e.addRules||e.removeRuleIds;){const s=e.addRules?.filter((e=>!t.has(e?.rqRuleId)))??[],a=e.removeRuleIds??[];try{await chrome.declarativeNetRequest.updateDynamicRules({addRules:s.map((e=>{const t={...e};return delete t.rqRuleId,t})),removeRuleIds:a});break}catch(e){const a=e.message.match(/Rule with id (\d+)/),n=a&&parseInt(a[1]),r=s.find((e=>e.id===n))?.rqRuleId;if(a&&r&&t.add(r),Ke({action:X,error:e.message,rqRuleId:r}),!a){console.error(`Error updating dynamic rules: ${e.message}`);break}}}},yt=async()=>{const e=await(async e=>{const s=await Ue(),a=await ke();return s.filter((s=>!(!s.status||s.status===t.INACTIVE)&&((!e||s.ruleType===e)&&(!s.groupId||a.find((e=>e.id===s.groupId)).status===t.ACTIVE))))})(),s=[],a=await Le();e.forEach((e=>{const t=e.extensionRules;t?.length&&t.forEach((t=>{t.condition.resourceTypes?.length||(t.condition.resourceTypes=It),t.condition.resourceTypes?.length&&t.condition.excludedResourceTypes?.length&&(t.condition.resourceTypes=t.condition.resourceTypes.filter((e=>!t.condition.excludedResourceTypes.includes(e)))),t.condition.excludedInitiatorDomains.push(...a),t.condition.excludedRequestDomains.push(...a);const n=s.length+1;s.push({...t,id:n,rqRuleId:e.id})}))})),await ft({addRules:s})},bt=async()=>{await(async()=>{const e=await chrome.declarativeNetRequest.getDynamicRules();return ft({removeRuleIds:e.map((e=>e.id))})})();await _e()&&await yt()},At=async()=>{Me(((e,t)=>{let s;return function(...a){clearTimeout(s),s=setTimeout((()=>e(...a)),t)}})(bt,500)),be(Ie.IS_EXTENSION_ENABLED,((e,t)=>{console.log("[initRulesManager.onVariableChange] IS_EXTENSION_ENABLED changed",{newValue:e,oldValue:t}),bt(),(async()=>{const e=await chrome.declarativeNetRequest.getSessionRules();chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:e.map((e=>e.id))})})()})),bt(),Ne((()=>{bt()}))},Dt=async(e,t,s,a)=>{let n=parseInt(`${Date.now()%1e6}${Math.floor(1e3*Math.random())}`);const r=He.getData(e,Fe.SESSION_RULES_MAP)??{},o=r?.[a]??{};let i=[];return o[t]&&(n=o[t],i.push(n)),He.setData(e,Fe.SESSION_RULES_MAP,{...r,[a]:{...o,[t]:n}}),chrome.declarativeNetRequest.updateSessionRules({addRules:[{id:n,...s}],removeRuleIds:i})},wt=["Authorization"],_t=(e,t)=>Object.keys(e).some((e=>e.toLowerCase()===t.toLowerCase())),Ct="rq_request_initiator_origin()";const Ot=new class{constructor(){}onBeforeAJAXRequest=async(e,t)=>{const a=await qe.getEnabledRules();if(0===a.length)return;const n=a.filter((e=>e.ruleType===s.REDIRECT||e.ruleType===s.REPLACE)),r=a.filter((e=>e.ruleType===s.HEADERS));await(async(e,t,s)=>{if(!wt.some((e=>_t(t.requestHeaders,e))))return;const{isApplied:a,destinationUrl:n}=b(s,t)??{};if(!a)return;const r=wt.map((e=>{const s=Object.keys(t.requestHeaders).find((t=>t.toLowerCase()===e.toLowerCase()));return s?{name:s,value:t.requestHeaders[s]}:null})).filter((e=>null!==e)),o=n;return Dt(e,t.url,{action:{requestHeaders:r.map((e=>({header:e.name,value:e.value,operation:"set"}))),type:"modifyHeaders"},condition:{urlFilter:`|${o}`,resourceTypes:["xmlhttprequest"],tabIds:[e],requestMethods:[t.method.toLowerCase()],excludedInitiatorDomains:["requestly.io","requestly.com"]}},Tt.FORWARD_IGNORED_HEADERS)})(e,t,n),await(async(e,t,s)=>{const{isApplied:a,matchedPair:n}=b(s,t)??{};if(!a)return;const r={Request:{},Response:{}};n.modifications?.Request?.length&&n.modifications.Request.forEach((e=>{e.value===Ct&&(r.Request[e.header]=t.initiator)})),n.modifications?.Response?.length&&n.modifications.Response.forEach((e=>{e.value===Ct&&(r.Response[e.header]=t.initiator)}));const o={};Object.keys(r.Request).length&&(o.requestHeaders=Object.entries(r.Request).map((([e,t])=>({header:e,value:t,operation:"set"})))),Object.keys(r.Response).length&&(o.responseHeaders=Object.entries(r.Response).map((([e,t])=>({header:e,value:t,operation:"set"})))),Object.keys(o).length&&await Dt(e,t.url,{action:{...o,type:"modifyHeaders"},condition:{urlFilter:`|${t.url}|`,resourceTypes:["xmlhttprequest"],tabIds:[e],requestMethods:n?.source?.filters?.[0]?.requestMethod?.map((e=>e.toLowerCase()))??void 0,excludedInitiatorDomains:["requestly.io","requestly.com"]}},Tt.INITIATOR_DOMAIN)})(e,t,r)};onErrorOccurred=async(e,t)=>{0!==(await qe.getEnabledRules()).length&&await(async(e,t)=>{await Dt(e,t.initiator,{action:{type:"modifyHeaders",responseHeaders:[{header:"Content-Security-Policy",operation:"remove"}]},condition:{urlFilter:t.initiator,resourceTypes:["sub_frame","main_frame"],tabIds:[e],excludedInitiatorDomains:["requestly.io","requestly.com"]}},Tt.CSP_ERROR)})(e,t)}};let Lt;const xt=new Uint8Array(16);function Nt(){if(!Lt&&(Lt="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Lt))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Lt(xt)}const vt=[];for(let e=0;e<256;++e)vt.push((e+256).toString(16).slice(1));var Pt={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Ut(e,t,s){if(Pt.randomUUID&&!t&&!e)return Pt.randomUUID();const a=(e=e||{}).random||(e.rng||Nt)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){s=s||0;for(let e=0;e<16;++e)t[s+e]=a[e];return t}return function(e,t=0){return vt[e[t+0]]+vt[e[t+1]]+vt[e[t+2]]+vt[e[t+3]]+"-"+vt[e[t+4]]+vt[e[t+5]]+"-"+vt[e[t+6]]+vt[e[t+7]]+"-"+vt[e[t+8]]+vt[e[t+9]]+"-"+vt[e[t+10]]+vt[e[t+11]]+vt[e[t+12]]+vt[e[t+13]]+vt[e[t+14]]+vt[e[t+15]]}(a)}const kt=async(e,t,s)=>{const a=await Se(he)??{},n=Object.values(a).filter((t=>t.ruleId===e)).sort(((e,t)=>e.timestamp<t.timestamp?1:e.timestamp>t.timestamp?-1:0));n.length>2&&delete a[n[2].id];const r=Ut();return a[r]={timestamp:Date.now(),ruleId:e,appliedStatus:s,url:t,id:r},await ge(he,a),r},Mt=["meet.google.com","*.requestly.io"],qt=async()=>chrome.proxy.settings.get({}).then((e=>"controlled_by_this_extension"===e.levelOfControl&&"fixed_servers"===e.value.mode)),Gt=59763,Ht="127.0.0.1",Ft=4,Bt={CONNECTION:1e3,HANDSHAKE:100};class jt{async findActivePort(){const e=Gt,t=e+Ft;try{if(await this.checkPort(e))return e}catch(t){console.log(`Default port ${e} not available`)}for(let s=e;s<=t;s++)try{if(await this.checkPort(s))return s}catch{continue}return Gt}checkPort(e){return new Promise(((t,s)=>{const a=new WebSocket(`ws://${Ht}:${e}`),n=setTimeout((()=>{a.close(),s(new Error("Connection timeout"))}),Bt.CONNECTION);a.onopen=()=>{clearTimeout(n),a.send(JSON.stringify({type:"handshake"}))},a.onmessage=e=>{try{"handshakeResponse"===JSON.parse(e.data).type&&(console.log("!!!debug","handshakeResponse Received",e.data),clearTimeout(n),a.close(),t(!0))}catch{a.close(),s(new Error("Invalid handshake response"))}},a.onerror=()=>{clearTimeout(n),a.close(),s(new Error("Connection failed"))}}))}}const Vt=()=>{const e=navigator.userAgent?.toLowerCase(),t=navigator.userAgentData?.brands?.map((e=>e.brand));if(!e)return"existing-browser";switch(!0){case e.includes("firefox"):return"existing-firefox";case e.includes("edg/"):return"existing-edge";case e.includes("opr")||e.includes("opera"):return"existing-opera";case navigator.brave||e.includes("brave")||t.includes("Brave"):return"existing-brave";case e.includes("chrome"):return t.includes("Google Chrome")?"existing-chrome":"existing-chromium";default:return"existing-browser"}};class Wt{socket=null;activePort=null;async init(){this.activePort||await this.findActivePort()}async connect(){return!!this.isConnected()||(await this.init(),this.establishConnection())}async sendMessage(e,t=!1){if(!this.isConnected())throw new Error("WebSocket is not open");const s={...e,source:"extension"};return this.socket.send(JSON.stringify(s)),t?new Promise((t=>{const s=a=>{const n=JSON.parse(a.data);"desktop-app"===n.source&&n.action===e.action&&(this.socket.removeEventListener("message",s),t(n))};this.socket.addEventListener("message",s)})):null}async disconnect(){try{this.isConnected()&&await this.sendMessage({action:"browser-disconnected",appId:Vt()})}catch(e){console.error("Disconnect error:",e)}finally{this.cleanup()}}async checkConnection(){return await this.init(),fetch(`http://${Ht}:${this.activePort}`).then((()=>!0)).catch((()=>!1))}isConnected(){return this.socket?.readyState===WebSocket.OPEN}async establishConnection(){return new Promise((e=>{this.socket=new WebSocket(`ws://${Ht}:${this.activePort}`),this.socket.onopen=()=>{console.log("WebSocket connection opened"),e(!0)},this.socket.onmessage=e=>this.handleMessage(e.data),this.socket.onerror=t=>{console.error("WebSocket error:",t),this.cleanup(),e(!1)},this.socket.onclose=()=>{console.log("WebSocket connection closed"),this.cleanup()}}))}async findActivePort(){const e=new jt;this.activePort=await e.findActivePort()}handleMessage(e){try{const t=JSON.parse(e);if("desktop-app"!==t.source)return;switch(t.action){case"heartbeat":this.sendMessage({action:"heartbeat"});break;case"disconnect-extension":this.disconnect();break;default:console.log("Unknown action:",t.action)}}catch(e){console.error("Message handling error:",e)}}cleanup(){this.socket&&(this.socket.close(),this.socket=null),(async()=>{if(await qt())chrome.proxy.settings.clear({scope:"regular"})?.catch((e=>{console.error("Error removing proxy",e)}))})(),Ye.markDisconnectedFromDesktopApp(),nt(!0),Ke({action:ee,payload:!1})}}const $t=new class{wsManager=new Wt;async connectAndSetupProxy(){if(!await this.wsManager.connect())return!1;try{const e=await this.getProxyDetails();return await(async e=>{if(!e)return;if(await qt())return;const t=await Le(),s=t.map((e=>`*.${e}`)),a=[...t,...s,...Mt];return chrome.proxy.settings.set({value:{mode:"fixed_servers",rules:{singleProxy:{scheme:"http",host:e.proxyIp,port:e.proxyPort},bypassList:a}},scope:"regular"})?.then((()=>{}))?.catch((e=>{console.error("Error applying proxy",e)}))})(e),Ke({action:ee,payload:!0}),nt(!1),Ye.markConnectedToDesktopApp(),await this.wsManager.sendMessage({action:"browser-connected",appId:Vt()}),!0}catch(e){return console.error("Setup failed:",e),await this.wsManager.disconnect(),!1}}async getProxyDetails(){const e=await this.wsManager.sendMessage({action:"get-proxy"},!0);return{proxyPort:e.proxyPort,proxyIp:Ht,proxyUrl:`http://${Ht}:${e.proxyPort}`}}async disconnect(){await this.wsManager.disconnect()}async checkDesktopAppStatus(){return this.wsManager.checkConnection()}},Xt=()=>{chrome.runtime.onMessage.addListener(((e,t,a)=>{switch(e.action){case _:_e().then((e=>{var a,n;e&&(a=t.tab?.id,n=t.frameId,at("libs/customElements.js",{tabId:a,frameIds:[n]}),(async(e,t,a,n)=>{if(De(a))return;if(await xe(n)||await xe(a))return;const r=await qe.getEnabledRules(s.SCRIPT),i=[],c=[];r.forEach((e=>{I(e,{url:a,type:0===t?o.MainDocument:o.IFrameDocument,method:"GET",initiator:n}).isApplied&&(c.push(e),e.pairs.forEach((e=>{e.scripts.forEach((e=>{i.push(e)}))})))}));for(let s of i)await st(s,{tabId:e,frameIds:[t]});c.length>0&&c.forEach((s=>{mt.onRuleExecuted(s,{url:a,tabId:e,method:"GET",type:0===t?o.MainDocument:o.IFrameDocument},!0)}))})(t.tab?.id,t.frameId,t.url,t.tab?.url))}));break;case G:mt.processTabCachedRulesExecutions(t.tab.id),(e=>{const t=He.getData(e.id,Fe.TEST_RULE_DATA);t?chrome.tabs.sendMessage(e.id,{action:ie,ruleId:t.ruleId,record:t.record}):chrome.tabs.sendMessage(e.id,{action:ce})})(t.tab),(async e=>{let t=He.getData(e.id,Fe.SESSION_RECORDING);if(t){if(!t.explicit&&!await rt(t.url))return void ct(e.id,!1)}else{const s=await rt(e.url);if(s){t={config:s,url:e.url};const a=s?.autoRecording?.mode;t.showWidget=a===c.CUSTOM,a===c.ALL_PAGES&&(t.markRecordingIcon=!1),He.setData(e.id,Fe.SESSION_RECORDING,t)}}t&&it(e.id,t).then((()=>{He.setData(e.id,Fe.SESSION_RECORDING,{...t,notify:!1,previousSession:null})}))})(t.tab,t.frameId);break;case q:return(async(e,t)=>{await at("libs/requestly-web-sdk.js",{tabId:e,frameIds:[t]})})(t.tab.id,t.frameId).then((()=>a())),!0;case se:d=t.tab.id,e.payload.markRecordingIcon&&Ye.markRecording(d);break;case ae:(e=>{Ye.markNotRecording(e)})(t.tab.id);break;case x:(async(e,t=!0)=>{const s=await rt(e.url),a=!!He.getData(e.id,Fe.SESSION_RECORDING);if(!s&&a)return;const n={explicit:!0,showWidget:t};He.setData(e.id,Fe.SESSION_RECORDING,n),it(e.id,n)})(e.tab??t.tab,e.showWidget);break;case N:i=e.url,chrome.tabs.create({url:i},(e=>{He.setData(e.id,Fe.SESSION_RECORDING,{notify:!0,explicit:!0,showWidget:!0})}));break;case v:ct(e.tabId??t.tab.id,e.openRecording);break;case w:return((e,t)=>{chrome.tabs.sendMessage(e,{action:ne},{frameId:0},t)})(e.tabId,a),!0;case D:return(async()=>{const[e,t]=await Promise.all([Ue(),ke()]);return{rules:e,groups:t}})().then(a),!0;case C:return Rt(e.apiRequest).then(a),!0;case O:return mt.getExecutedRules(e.tabId??t.tab.id).then(a),!0;case L:return(async()=>0===(await Ue()).length)().then(a),!0;case U:return _e().then(a),!0;case k:return console.log("[Toggle extension status] message received",{message:e}),nt(e.newStatus).then((e=>{const t={success:!0,updatedStatus:e};a(t),console.log("[Toggle extension status] response sent",{...t,extensionIconState:Ye.getState()})})).catch((t=>{a({success:!1}),console.log("[messageHandler.handleToggleExtensionStatus] Error occurred while updating extension status.",{error:t.message,extensionIconState:Ye.getState(),message:e})})),!0;case P:ot(e.tabId??t.tab?.id);break;case M:((e,t)=>{const s=He.getData(e,Fe.SESSION_RECORDING);s&&He.setData(e,Fe.SESSION_RECORDING,{...s,previousSession:t.session,widgetPosition:t.widgetPosition,recordingStartTime:t.recordingStartTime})})(t.tab.id,e.payload);break;case H:return Ot.onBeforeAJAXRequest(t.tab.id,e.requestDetails).then(a),!0;case F:return Ot.onErrorOccurred(t.tab.id,e.requestDetails).then(a),!0;case V:n=e,r=t.tab.id,He.createNewTab(n.url,r,(e=>{He.setData(e.id,Fe.TEST_RULE_DATA,{url:n.url,ruleId:n.ruleId,record:n.record})}));break;case B:((e,t)=>{const s=He.getData(t.id,Fe.TEST_RULE_DATA),a=s.url??t.url;kt(e.ruleId,a,e.appliedStatus).then((a=>{He.focusTab(t.openerTabId)?chrome.tabs.sendMessage(t.openerTabId,{action:j,testReportId:a,testPageTabId:t.id,record:s.record,appliedStatus:e.appliedStatus}):chrome.tabs.create({url:`${E.WEB_URL}/rules/editor/edit/${e.ruleId}`},(n=>{He.ensureTabLoadingComplete(n.id).then((()=>{chrome.tabs.sendMessage(n.id,{action:j,testReportId:a,testPageTabId:t.id,record:s.record,appliedStatus:e.appliedStatus})}))}))}))})(e,t.tab);break;case W:const u={...e.requestDetails,tabId:e.requestDetails?.tabId||t.tab?.id};mt.onRuleExecuted(e.rule,u);break;case Q:if(!e.tabUrl){a(!1);break}return xe(e.tabUrl).then((e=>a(e))).catch((()=>a(!1))),!0;case $:Ke({action:ue});break;case J:Be.updateSharedStateInStorage(t.tab.id,e.sharedState);break;case z:return $t.connectAndSetupProxy().then(a).catch((()=>a(!1))),!0;case Z:return $t.disconnect().then(a).catch((()=>a(!1))),!0;case Y:return qt().then(a),!0;case K:return $t.checkDesktopAppStatus().then(a),!0}var n,r,i,d;return!1}))},Qt=async e=>{if(e?.documentLifecyle&&"active"!==e?.documentLifecycle&&"prerender"!==e?.documentLifecycle)return;let t="main_frame"===e.type||"prerender"===e.documentLifecycle;await xe(e.initiator)||await xe(e.url)||qe.getEnabledRules().then((a=>{a.forEach((a=>{switch(a.ruleType){case s.REDIRECT:case s.REPLACE:case s.QUERYPARAM:case s.CANCEL:case s.DELAY:const{isApplied:n}=I(a,{url:e.url,method:e.method,type:e.type,initiator:e.initiator});n&&mt.onRuleExecuted(a,e,t)}}))}))},Jt=async e=>{let t="main_frame"===e.type||"prerender"===e.documentLifecycle;await xe(e.initiator)||await xe(e.url)||qe.getEnabledRules().then((a=>{a.forEach((a=>{switch(a.ruleType){case s.HEADERS:case s.USERAGENT:const{isApplied:n,matchedPair:r}=I(a,{url:e.url,method:e.method,type:e.type,initiator:e.initiator});n&&r.modifications?.Request&&r.modifications?.Request?.length>0&&mt.onRuleExecuted(a,e,t)}}))}))},Yt=async e=>{let t="main_frame"===e.type||"prerender"===e.documentLifecycle;await xe(e.initiator)||await xe(e.url)||qe.getEnabledRules().then((a=>{a.forEach((a=>{if(a.ruleType===s.HEADERS){const{isApplied:s,matchedPair:n}=I(a,{url:e.url,method:e.method,type:e.type,initiator:e.initiator});s&&n.modifications?.Response&&n.modifications?.Response?.length>0&&mt.onRuleExecuted(a,e,t)}}))}))},Kt=()=>{if(chrome.webRequest.onBeforeRequest.hasListener(Qt)||chrome.webRequest.onBeforeRequest.addListener(Qt,{urls:["<all_urls>"]}),!chrome.webRequest.onBeforeSendHeaders.hasListener(Jt)){chrome.webRequest.onBeforeSendHeaders.addListener(Jt,{urls:["<all_urls>"]},["requestHeaders"])}if(!chrome.webRequest.onHeadersReceived.hasListener(Yt)){chrome.webRequest.onHeadersReceived.addListener(Yt,{urls:["<all_urls>"]},["responseHeaders"])}},zt=()=>{_e().then((e=>{e&&Kt()})),be(Ie.IS_EXTENSION_ENABLED,(e=>{e?Kt():(chrome.webRequest.onBeforeRequest.removeListener(Qt),chrome.webRequest.onBeforeSendHeaders.removeListener(Jt),chrome.webRequest.onHeadersReceived.removeListener(Yt))}))};(async()=>{(async()=>{console.log("[initClientHandler]");const e=await _e();Xe(e),be(Ie.IS_EXTENSION_ENABLED,(e=>{console.log("[initClientHandler]","onVariableChange",{extensionStatus:e}),Xe(e)})),Ne((()=>{$e().then((()=>{Xe(e)}))}))})(),(async()=>{let e=await _e();be(Ie.IS_EXTENSION_ENABLED,(t=>{e=t})),chrome.webNavigation.onCommitted.addListener((async t=>{e&&(Je(t.tabId,t.frameId),Be.initSharedStateCaching(t.tabId))})),qe.onRuleOrGroupChange((async()=>{e&&chrome.tabs.query({},(e=>{e.forEach((e=>{Je(e.id,void 0)}))}))}))})(),chrome.commands.onCommand.addListener((e=>{"reload"===e&&chrome.runtime.reload()})),chrome.runtime.onInstalled.addListener(Et),chrome.runtime.setUninstallURL(E.WEB_URL+"/goodbye/"),At(),Xt(),chrome.runtime.onMessageExternal.addListener(((e,t,s)=>{e.action===te&&s({name:chrome.runtime.getManifest().name,version:chrome.runtime.getManifest().version})})),(async()=>{chrome.contextMenus.removeAll(),chrome.contextMenus.create({id:dt.TOGGLE_ACTIVATION_STATUS,title:ut.DEACTIVATE,contexts:["action"]}),chrome.contextMenus.onClicked.addListener((async e=>{if(e.menuItemId===dt.TOGGLE_ACTIVATION_STATUS){const e=!await _e();console.log("[initContextMenu.listener] context menu clicked",{extensionStatus:e,extensionIconState:Ye.getState()}),await ye(Ie.IS_EXTENSION_ENABLED,e),lt(e),Ke({action:le,isExtensionEnabled:e,extensionIconState:Ye.getState()})}}));const e=await _e();lt(e)})(),zt(),chrome.runtime.onConnect.addListener((function(e){"rq_devtools"===e.name&&(e.onMessage.addListener((function(t){switch(t.action){case"registerDevTool":pt.set(t.tabId,e);break;case"heartbeat":return}})),e.onDisconnect.addListener((function(e){pt.forEach(((t,s)=>{t===e&&pt.delete(s)}))})))}))})()}();
